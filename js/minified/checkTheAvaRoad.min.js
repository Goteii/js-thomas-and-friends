import{AVA_ROADS as e}from"../../utils/avaRoads.js";import{createMyElement as t,createColumnOfDifferentTierItems as s}from"../resultBuildMethods.js";let wait=(e=0)=>new Promise(t=>setTimeout(t,e)),setVisible=(e,t)=>("string"==typeof e?document.querySelector(e):e).style.display=t?"block":"none";setVisible(".content",!1),setVisible("#loading",!0),document.addEventListener("DOMContentLoaded",()=>wait(1200).then(()=>{setVisible(".content",!0),setVisible("#loading",!1)}));let getClassNameForMapName=e=>{let t=0,s=0,l=0,i=0,n=0,r=0,o=0,a=0,d=0,c=[];return e.greenChests&&e.greenChests.length&&(e.greenChests.forEach(e=>t+=e.amount),c.push({name:"green-chest-color",amount:t})),e.blueChests&&e.blueChests.length&&(e.blueChests.forEach(e=>s+=e.amount),c.push({name:"blue-chest-color",amount:s})),e.goldChests&&e.goldChests.length&&(e.goldChests.forEach(e=>l+=e.amount),c.push({name:"gold-chest-color",amount:l})),e.dungeons&&e.dungeons.length&&(e.dungeons.forEach(e=>i+=e.amount),c.push({name:"dungeon-color",amount:i})),e.leatherGatheringSpots&&e.leatherGatheringSpots.length&&e.leatherGatheringSpots.forEach(e=>n+=e.amount),e.ironGatheringSpots&&e.ironGatheringSpots.length&&e.ironGatheringSpots.forEach(e=>r+=e.amount),e.stoneGatheringSpots&&e.stoneGatheringSpots.length&&e.stoneGatheringSpots.forEach(e=>o+=e.amount),e.woodGatheringSpots&&e.woodGatheringSpots.length&&e.woodGatheringSpots.forEach(e=>a+=e.amount),e.fluxGatheringSpots&&e.fluxGatheringSpots.length&&e.fluxGatheringSpots.forEach(e=>d+=e.amount),c.push({name:"gathering-spot-color",amount:n+r+o+a+d}),c.sort((e,t)=>t.amount-e.amount),c[0].name},createResults=e=>{let l=document.getElementById("search-results");if(!e.length){let i=document.createElement("p");i.innerHTML="We couldnt find a result matching your applied filters/requirements. We might not have that kind of Avalonian Road in our database or it simply doesnt exist.",i.className="results-not-found",i.id="results-not-found",console.log(i),l.appendChild(i)}e.length&&document.getElementById("results-not-found")&&document.getElementById("results-not-found").remove(),e.length&&e.forEach(e=>{let i=document.createElement("div");i.className="result";let n=document.createElement("img");n.src=e.imgSrc,n.alt=`${e.name} map`,n.style.width="360px",i.appendChild(n);let r=t("h4",getClassNameForMapName(e),e.name);i.appendChild(r);let o=t("h5","",`Tier: ${e.mapTier}`);i.appendChild(o);let a=t("div","result__details");if(e.blueChests.length||e.greenChests.length||e.goldChests.length){let d=t("p","","Chests:");a.appendChild(d);let c=t("div","result__details--chests");if(e.greenChests.length){let h=t("div","result__details--green");s({items:e.greenChests,divClassName:"chest-info",amountSpanClassName:"green-chest",tierSpanClassName:"green-chest__tier",wrapper:h}),c.appendChild(h)}if(e.blueChests.length){let g=t("div","result__details--blue");s({items:e.blueChests,divClassName:"chest-info",amountSpanClassName:"blue-chest",tierSpanClassName:"blue-chest__tier",wrapper:g}),c.appendChild(g)}if(e.goldChests.length){let m=t("div","result__details--gold");s({items:e.goldChests,divClassName:"chest-info",amountSpanClassName:"gold-chest",tierSpanClassName:"gold-chest__tier",wrapper:m}),c.appendChild(m)}a.appendChild(c)}if(e.dungeons.length){let f=document.createElement("p");f.innerHTML="Dungeons:",a.appendChild(f);let p=document.createElement("div");p.className="result__details--dungeons",e.dungeons.forEach(e=>{let t=document.createElement("div");t.className="dungeon-info";let s=document.createElement("span");s.className="dungeon",s.innerHTML=`${e.amount}x `,t.appendChild(s);let l=document.createElement("span");l.className="dungeon__tier",l.innerHTML=e.tier,t.appendChild(l),p.appendChild(t)}),a.appendChild(p)}if(e.ironGatheringSpots||e.leatherGatheringSpots){let u=t("p","","Gathering spots:");a.appendChild(u);let I=t("div","result__details--gatheringspots");if(e.leatherGatheringSpots){let b=t("div","result_details--leather");s({items:e.leatherGatheringSpots,divClassName:"gatheringspot-info",amountSpanClassName:"gatheringspot--leather",tierSpanClassName:"gatheringspot__tier",wrapper:b}),I.appendChild(b)}if(e.ironGatheringSpots){let y=t("div","result_details--iron");s({items:e.ironGatheringSpots,divClassName:"gatheringspot-info",amountSpanClassName:"gatheringspot--iron",tierSpanClassName:"gatheringspot__tier",wrapper:y}),I.appendChild(y)}a.appendChild(I)}i.appendChild(a),l.appendChild(i)})},filtersAmount={greenChests:1,blueChests:1,goldChests:1,dungeons:1,gatheringSpots:1},filtersAmountRequirements={greenChests:3,blueChests:3,goldChests:3,dungeons:3,gatheringSpots:11},createRemoveBtn=(e,t,s,l)=>{let i=document.createElement("button");i.className="add-filter-btn",i.id=`${t}-btn-${filtersAmount[e]}`,i.innerHTML="-";let n=document.getElementById(l),r=Array.from(n.children).filter(e=>e.id.includes(t)).splice(-1)[0].id.split("-").splice(-1)[0],o=document.getElementById(`${t}-${r}`);i.onclick=()=>{o.remove(),filtersAmount[e]--;let t=document.getElementById(s);t.classList.remove("hidden")},o.appendChild(i)},getProperId=(e,t,s)=>{let l=s,i=document.getElementById(`${t}-${l}`);if(!i)return l;if(i){let n=++l;return getProperId(e,t,n)}},createFilters=(e,s,l,i,n)=>{if(filtersAmount[e]!==filtersAmountRequirements[e]&&createRemoveBtn(e,n,i,s),filtersAmount[e]>=filtersAmountRequirements[e])return;filtersAmount[e]++;let r=getProperId(e,n,1),o=document.getElementById(i);o.remove();let a=document.getElementById(s),d=t("div","filters__chests--chest");d.id=`${n}-${r}`;let c=t("div","filters__chests--tier"),h=document.createElement("label");h.htmlFor=`${l}-tier`,h.innerHTML="Tier:",c.appendChild(h);let g=document.createElement("select");g.className="chest-tier-select",g.name=`${l}-tier`,g.id=`${l}-tier-${r}`;let m=document.createElement("option");m.value="IV",m.innerHTML="IV",g.appendChild(m);let f=document.createElement("option");f.value="VI",f.innerHTML="VI",g.appendChild(f);let p=document.createElement("option");p.value="VIII",p.innerHTML="VIII",g.appendChild(p),c.appendChild(g),d.appendChild(c);let u=t("div","filters__chests--amount"),I=document.createElement("label");I.htmlFor=`${l}-amount`,I.innerHTML="At least(amount):",u.appendChild(I);let b=document.createElement("input");b.name=`${l}-amount`,b.type="number",b.min="1",b.max="5",b.value="1",b.className=`chest-amount ${l}`,b.id=`${l}-amount-${r}`,u.appendChild(b),d.appendChild(u);let y=Array.from(a.children).filter(e=>e.className.includes("error"));y?(y.forEach(e=>{e.remove()}),a.appendChild(d),y.forEach(e=>{a.appendChild(e)})):a.appendChild(d);let C=Array.from(a.children).filter(e=>e.id.includes(n)).length;d.appendChild(o),3===C&&o.classList.add("hidden")},categoryNameIdTabIdDictionary={"green-chest":{categoryNameId:"category-name-green-chests",tabId:"filters-option-chests-tab"},"blue-chest":{categoryNameId:"category-name-blue-chests",tabId:"filters-option-chests-tab"},"gold-chest":{categoryNameId:"category-name-gold-chests",tabId:"filters-option-chests-tab"},dungeons:{categoryNameId:"category-name-dungeons",tabId:"filters-option-dungeons-tab"},leather:{categoryNameId:"category-name-leather-spots",tabId:"filters-option-gatheringspots-tab"},iron:{categoryNameId:"category-name-iron-spots",tabId:"filters-option-gatheringspots-tab"},wood:{categoryNameId:"category-name-wood-spots",tabId:"filters-option-gatheringspots-tab"},stone:{categoryNameId:"category-name-stone-spots",tabId:"filters-option-gatheringspots-tab"},flux:{categoryNameId:"category-name-flux-spots",tabId:"filters-option-gatheringspots-tab"}},mainItemCheckboxesDictionary={greenChest:{type:"greenChests",filterId:"green-chest-filter",htmlNodeName:"green-chest",btnId:"add-filter-green-chest",checkboxId:"green-chest-checkbox",fieldsetId:"green-chest-fieldset"},blueChest:{type:"blueChests",filterId:"blue-chest-filter",htmlNodeName:"blue-chest",btnId:"add-filter-blue-chest",checkboxId:"blue-chest-checkbox",fieldsetId:"blue-chest-fieldset"},goldChest:{type:"goldChests",filterId:"gold-chest-filter",htmlNodeName:"gold-chest",btnId:"add-filter-gold-chest",checkboxId:"gold-chest-checkbox",fieldsetId:"gold-chest-fieldset"},dungeons:{type:"dungeons",filterId:"dungeons-filter",htmlNodeName:"dungeons",btnId:"add-filter-dungeons",checkboxId:"dungeons-checkbox",fieldsetId:"dungeons-fieldset"},leather:{type:"gatheringSpots",filterId:"leather-filter",htmlNodeName:"leather",btnId:"add-filter-leather",checkboxId:"leather-checkbox",fieldsetId:"leather-fieldset"},iron:{type:"gatheringSpots",filterId:"iron-filter",htmlNodeName:"iron",btnId:"add-filter-iron",checkboxId:"iron-checkbox",fieldsetId:"iron-fieldset"},wood:{type:"gatheringSpots",filterId:"wood-filter",htmlNodeName:"wood",btnId:"add-filter-wood",checkboxId:"wood-checkbox",fieldsetId:"wood-fieldset"},stone:{type:"gatheringSpots",filterId:"stone-filter",htmlNodeName:"stone",btnId:"add-filter-stone",checkboxId:"stone-checkbox",fieldsetId:"stone-fieldset"},flux:{type:"gatheringSpots",filterId:"flux-filter",htmlNodeName:"flux",btnId:"add-filter-flux",checkboxId:"flux-checkbox",fieldsetId:"flux-fieldset"}},listenToMainCheckboxes=()=>{for(let[e,t]of Object.entries(mainItemCheckboxesDictionary)){let s=t,l=document.getElementById(s.checkboxId),i=document.getElementById(s.btnId);l.addEventListener("change",()=>{let e=document.getElementById(s.btnId),t=document.getElementById(s.filterId);if(l.checked)t.classList.remove("hidden"),e&&!e.onclick&&(e.onclick=()=>{createFilters(s.type,s.filterId,s.htmlNodeName,s.btnId,s.fieldsetId,s.categoryNameId,s.tabId)});else if(t.classList.contains("hidden")||t.classList.add("hidden"),t.classList.contains("error-wrapper")&&t.classList.remove("error-wrapper"),t.children.length>1){let n=Array.from(t.children).filter(e=>e.id).length-1;Array.from(t.children).forEach((e,t)=>{t!==n&&e.remove()}),filtersAmount[s.type]=1,i.classList.contains("hidden")&&i.classList.remove("hidden"),t.children[0].appendChild(i)}})}};listenToMainCheckboxes();let checkboxesIdToFiltersIdDic={"green-chest-checkbox":"green-chest-filter","blue-chest-checkbox":"blue-chest-filter","gold-chest-checkbox":"gold-chest-filter","dungeons-checkbox":"dungeons-filter","leather-checkbox":"leather-filter","iron-checkbox":"iron-filter","stone-checkbox":"stone-filter","wood-checkbox":"wood-filter","flux-checkbox":"flux-filter"},tiersIdToAmountsIdDic={"green-chest-tier":"green-chest-amount","blue-chest-tier":"blue-chest-amount","gold-chest-tier":"gold-chest-amount","dungeons-tier":"dungeons-amount","leather-tier":"leather-amount","iron-tier":"iron-amount","stone-tier":"stone-amount","wood-tier":"wood-amount","flux-tier":"flux-amount"},errorMsgsDictionary={tier:"You cant look for the same tiers of the same thing in two different fieldsets of the same thing",amount:"Amount of thing you are looking for must be more than 1 and less than 7"},validation={result:"no-errors",fieldsetsInfo:{"green-chest-filter":{},"blue-chest-filter":{},"gold-chest-filter":{},"dungeons-filter":{},"leather-filter":{},"iron-filter":{},"stone-filter":{},"wood-filter":{},"flux-filter":{}}},validateFilters=()=>{clearErrorMessages(validation.fieldsetsInfo);let e=[];for(let[t,s]of Object.entries(checkboxesIdToFiltersIdDic)){let l=document.getElementById(t);l.checked&&e.push({checkbox:l,filter:document.getElementById(s)})}return e.length&&e.forEach(e=>{let t=e.checkbox.id.split("-");t.splice(-1);let s=t.length>1?t.join("-"):t.toString(),l=[];Array.from(e.filter.children).forEach(t=>{if(t.id){let i=t.id.split("-").splice(-1),n=document.getElementById(`${s}-tier-${i}`).value,r=+document.getElementById(`${s}-amount-${i}`).value;l.includes(n)&&(validation.result="error",validation.fieldsetsInfo[e.filter.id].tier=errorMsgsDictionary.tier),l.includes(n)||l.push(n),(r>7||r<1)&&(validation.result="error",validation.fieldsetsInfo[e.filter.id].amount=errorMsgsDictionary.amount)}})}),"error"===validation.result&&createErrorMsg(validation.fieldsetsInfo),e.length||(validation.result="no-filters"),validation},clearErrorMessages=e=>{Object.keys(e).forEach(e=>{let t=document.getElementById(e),s=e.split("-");s.pop();let l=s.join("-"),i=categoryNameIdTabIdDictionary[l].categoryNameId,n=categoryNameIdTabIdDictionary[l].tabId,r=document.getElementById(i),o=document.getElementById(n);Array.from(t.children).forEach(e=>{e.className.includes("error")&&e.remove(),r.classList.contains("category-exclamation")&&r.classList.remove("category-exclamation"),o.classList.contains("tab-exclamation")&&o.classList.remove("tab-exclamation")})}),validation={result:"no-errors",fieldsetsInfo:{"green-chest-filter":{},"blue-chest-filter":{},"gold-chest-filter":{},"dungeons-filter":{},"leather-filter":{},"iron-filter":{},"stone-filter":{},"wood-filter":{},"flux-filter":{}}}},createErrorMsg=e=>{for(let[t,s]of Object.entries(e)){let l=t.split("-");l.pop();let i=l.join("-"),n=categoryNameIdTabIdDictionary[i].categoryNameId,r=categoryNameIdTabIdDictionary[i].tabId,o=document.getElementById(n),a=document.getElementById(r);if(Object.keys(s).length){let d=document.getElementById(t);Object.values(s).forEach((e,t)=>{let s=document.createElement("p");s.innerHTML=e,s.className=`error-${t}`,d.appendChild(s),o.classList.add("category-exclamation"),a.classList.add("tab-exclamation")})}}},fetchAvaRoads=()=>{let t=document.getElementById("searchInput").value.toLowerCase(),s,l=validateFilters();if("error"!==l.result){let i=document.getElementsByClassName("result");i.length>0&&Array.from(i).forEach(e=>e.remove()),s=t?e.filter(e=>e.name.toLowerCase().includes(t)):e,"no-errors"===l.result&&(s=getFilteredResults()),createResults(s)}};fetchAvaRoads();let filterDictionary={"green-chest":"greenChests","blue-chest":"blueChests","gold-chest":"goldChests",dungeons:"dungeons",leather:"leatherGatheringSpots",iron:"ironGatheringSpots",wood:"woodGatheringSpots",stone:"stoneGatheringSpots",flux:"fluxGatheringSpots"},getFilteredResults=t=>{let s=document.querySelectorAll('input[id*="checkbox"]'),l=Array.from(s).filter(e=>e.checked),i={};l.forEach(e=>{let t=e.id.split("-");t.splice(-1);let s=t.join("-"),l=`${s}-filter`,n=`${s}-tier`,r=`${s}-amount`,o=document.getElementById(l);Array.from(o.children).forEach((e,t)=>{let l=e.id.split("-").splice(-1),o=document.getElementById(`${n}-${l}`).value,a=document.getElementById(`${r}-${l}`).value;i[s]={...i[s],[t]:{amount:+a,tier:o}}})});let n=t?e.filter(e=>e.name.toLowerCase().includes(searchInput)):e,r=[];return n.forEach(e=>{let t=[];for(let[s,l]of Object.entries(i))if(e[filterDictionary[s]]){let n=Object.values(l);if(n.length>e[filterDictionary[s]].length){t.push(!1);return}n.forEach(l=>{let i=e[filterDictionary[s]].find(e=>e.tier===l.tier);i||t.push(!1),i&&l.amount>i.amount&&t.push(!1)})}t.includes(!1)||r.push(e)}),r},clearFilters=()=>{let e=document.querySelectorAll('input[id*="checkbox"]'),t=Array.from(e).filter(e=>e.checked);t.forEach(e=>e.click()),clearErrorMessages(validation.fieldsetsInfo)},searchBtn=document.getElementById("search__btn");searchBtn.addEventListener("click",()=>fetchAvaRoads());let clearFiltersBtn=document.getElementById("clear-filters");clearFiltersBtn.addEventListener("click",()=>clearFilters()),document.querySelector("body").addEventListener("keypress",e=>{"Enter"===e.key&&(e.preventDefault(),searchBtn.click())});let filterTabsIdTofilterOptionsId={"filters-option-chests-tab":"filters-option-chests","filters-option-dungeons-tab":"filters-option-dungeons","filters-option-gatheringspots-tab":"filters-option-gatheringspots"},showFilterOptions=(e,t)=>{Object.keys(filterTabsIdTofilterOptionsId).forEach(e=>{let s=document.getElementById(e);e===t?s.classList.contains("active")||s.classList.add("active"):s.classList.contains("active")&&s.classList.remove("active")}),Object.values(filterTabsIdTofilterOptionsId).forEach(t=>{let s=document.getElementById(t);s.id!==e?(s.classList.contains("show")&&s.classList.remove("show"),s.classList.add("covered")):(s.classList.contains("covered")&&s.classList.remove("covered"),s.classList.add("show"))})};showFilterOptions(Object.values(filterTabsIdTofilterOptionsId)[0],Object.keys(filterTabsIdTofilterOptionsId)[0]);let filtersTabs=document.getElementsByClassName("filters__tabs")[0];Array.from(filtersTabs.children).forEach(e=>{e.addEventListener("click",()=>{showFilterOptions(filterTabsIdTofilterOptionsId[e.id],e.id)})});let hideFiltersBtn=document.getElementById("hide-filters");hideFiltersBtn.addEventListener("click",()=>{let e=document.getElementById("filters");e.classList.contains("show-animated")?(e.classList.remove("show-animated"),e.classList.add("covered-animated"),hideFiltersBtn.innerHTML="Show filters",clearFilters()):(e.classList.contains("covered")&&e.classList.remove("covered"),e.classList.remove("covered-animated"),e.classList.add("show-animated"),hideFiltersBtn.innerHTML="Hide filters")});
